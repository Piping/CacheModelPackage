require <str> require <str> require <str> class HabtmDestroyOrderTest < ActiveRecord :: TestCase test <str> do sicp = Lesson . new ( <str> = > <str> ) ben = Student . new ( <str> = > <str> ) sicp . students << ben sicp . save! assert_raises LessonError do assert_no_difference ( <str> ) do sicp . destroy end end assert ! sicp . destroyed? end test <str> do student = Student . new ( <str> = > <str> ) lesson = Lesson . new ( <str> = > <str> ) lesson . students << student lesson . save! assert_nothing_raised do student . destroy end end test <str> do begin sicp = Lesson . new ( <str> = > <str> ) ben = Student . new ( <str> = > <str> ) Student . class_eval do before_destroy do raise ActiveRecord :: Rollback unless lessons . empty? end end ben . lessons << sicp ben . save! ben . destroy assert ! ben . reload . lessons . empty? ensure Student . reset_callbacks ( <str> ) end end test <str> do sicp = Lesson . new ( <str> = > <str> ) ben = Student . new ( <str> = > <str> ) sicp . students << ben sicp . save! assert_raises LessonError do sicp . destroy end assert ! sicp . reload . students . empty? end end 
