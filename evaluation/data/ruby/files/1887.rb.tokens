class SpamHandler def self . should_prevent_registration_from_ip? ( ip_address ) return false if SiteSetting . max_new_accounts_per_registration_ip < = <int> tl2_plus_accounts_with_same_ip = User . where ( <str> , TrustLevel [ <int> ] ) . where ( <str> : ip_address . to_s ) . count return false if tl2_plus_accounts_with_same_ip > <int> staff_user_ids = Group [ <str> ] . user_ids - [ - <int> ] staff_members_with_same_ip = User . where ( id : staff_user_ids ) . where ( <str> : ip_address . to_s ) . count return false if staff_members_with_same_ip > <int> ip_whitelisted = ScreenedIpAddress . is_whitelisted? ( ip_address ) return false if ip_whitelisted tl0_accounts_with_same_ip = User . unscoped . where ( <str> : TrustLevel [ <int> ] ) . where ( <str> : ip_address . to_s ) . count tl0_accounts_with_same_ip > = SiteSetting . max_new_accounts_per_registration_ip end end 
