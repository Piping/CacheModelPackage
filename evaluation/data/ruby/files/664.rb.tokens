require <str> require File . expand_path ( File . dirname ( __FILE__ ) + <str> ) class ImportScripts :: PunBB < ImportScripts :: Base PUNBB_DB = <str> BATCH_SIZE = <int> def initialize super @client = Mysql2 :: Client . new ( <str> : <str> , <str> : <str> , <str> : <str> , <str> : PUNBB_DB ) end def execute import_users import_categories import_posts suspend_users end def import_users puts <str> , <str> total_count = mysql_query ( <str> ) . first [ <str> ] batches ( BATCH_SIZE ) do | offset | results = mysql_query ( <str> BATCH_SIZE <str> offset <str> ) break if results . size < <int> next if all_records_exist? <str> , users . map { | u | u [ <str> ] . to_i } create_users ( results , <str> : total_count , <str> : offset ) do | user | { id : user [ <str> ] , <str> : user [ <str> ] , <str> : user [ <str> ] , name : user [ <str> ] , <str> : Time . zone . at ( user [ <str> ] ) , <str> : user [ <str> ] , <str> : user [ <str> ] , <str> : Time . zone . at ( user [ <str> ] ) , <str> : user [ <str> ] == nil ? <int> : Time . zone . at ( user [ <str> ] ) , <str> : user [ <str> ] , <str> : user [ <str> ] == <int> , <str> : user [ <str> ] == <int> } end end end def import_categories puts <str> , <str> categories = mysql_query ( <str> ) . to_a create_categories ( categories ) do | category | { id : category [ <str> ] , name : category [ <str> ] } end puts <str> , <str> children_categories = mysql_query ( <str> ) . to_a create_categories ( children_categories ) do | category | { id : <str> category [ <str> ] <str> , name : category [ <str> ] , <str> : category [ <str> ] , <str> : category_id_from_imported_category_id ( category [ <str> ] ) } end end def import_posts puts <str> , <str> total_count = mysql_query ( <str> ) . first [ <str> ] batches ( BATCH_SIZE ) do | offset | results = mysql_query ( <str> BATCH_SIZE <str> offset <str> ) . to_a break if results . size < <int> next if all_records_exist? <str> , results . map { | m | m [ <str> ] . to_i } create_posts ( results , <str> : total_count , <str> : offset ) do | m | skip = false mapped = { } mapped [ <str> ] = m [ <str> ] mapped [ <str> ] = user_id_from_imported_user_id ( m [ <str> ] ) || - <int> mapped [ <str> ] = process_punbb_post ( m [ <str> ] , m [ <str> ] ) mapped [ <str> ] = Time . zone . at ( m [ <str> ] ) if m [ <str> ] == m [ <str> ] mapped [ <str> ] = category_id_from_imported_category_id ( <str> m [ <str> ] <str> ) mapped [ <str> ] = CGI . unescapeHTML ( m [ <str> ] ) else parent = topic_lookup_from_imported_post_id ( m [ <str> ] ) if parent mapped [ <str> ] = parent [ <str> ] else puts <str> m [ <str> ] <str> m [ <str> ] <str> m [ <str> ] [ <int> .. <int> ] <str> skip = true end end skip ? nil : mapped end end end def suspend_users puts <str> , <str> banned = <int> failed = <int> total = mysql_query ( <str> ) . first [ <str> ] system_user = Discourse . system_user mysql_query ( <str> ) . each do | b | user = User . find_by_email ( b [ <str> ] ) if user user . suspended_at = Time . now user . suspended_till = <int> . years . from_now if user . save StaffActionLogger . new ( system_user ) . log_user_suspend ( user , <str> ) banned += <int> else puts <str> user . username <str> user . errors . try ( <str> ) . try ( <str> ) <str> failed += <int> end else puts <str> b [ <str> ] <str> failed += <int> end print_status banned + failed , total end end def process_punbb_post ( raw , import_id ) s = raw . dup s . gsub! ( <str> , <str> ) s . gsub! ( <str> , <str> ) s . gsub! ( <str> , <str> ) s . gsub! ( <str> , <str> ) s = CGI . unescapeHTML ( s ) s . gsub! ( <str> , <str> ) s end def mysql_query ( sql ) @client . query ( sql , <str> : false ) end end ImportScripts :: PunBB . new . perform 
