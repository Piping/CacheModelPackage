class ContributedProjectsFinder def initialize ( user ) @user = user end def execute ( current_user = nil ) if current_user relation = projects_visible_to_user ( current_user ) else relation = public_projects end relation . includes ( <str> ) . order_id_desc end private def projects_visible_to_user ( current_user ) authorized = @user . contributed_projects . visible_to_user ( current_user ) union = Gitlab :: SQL :: Union . new ( [ authorized . select ( <str> ) , public_projects . select ( <str> ) ] ) Project . where ( <str> union . to_sql <str> ) end def public_projects @user . contributed_projects . public_only end end 
