module ImportScripts::PhpBB3 class CategoryImporter def initialize ( lookup , text_processor ) @lookup = lookup @text_processor = text_processor end def map_category ( row ) { id : row [ <str> ] , name : CGI . unescapeHTML ( row [ <str> ] ) , <str> : @lookup . category_id_from_imported_category_id ( row [ <str> ] ) , <str> : proc do | category | update_category_description ( category , row ) end } end protected def update_category_description ( category , row ) return if row [ <str> ] . blank? && row [ <str> ] . blank? topic = category . topic post = topic . first_post if row [ <str> ] . present? created_at = Time . zone . at ( row [ <str> ] ) topic . created_at = created_at topic . save post . created_at = created_at post . save end if row [ <str> ] . present? changes = { <str> : @text_processor . process_raw_text ( row [ <str> ] ) } opts = { <str> : post . created_at , <str> : true } post . revise ( Discourse . system_user , changes , opts ) end end end end 
