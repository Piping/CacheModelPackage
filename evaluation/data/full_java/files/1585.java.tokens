package org . apache . cassandra . locator ; import java . io . IOException ; import java . net . InetAddress ; import java . net . UnknownHostException ; import java . util . EnumMap ; import java . util . Map ; import org . junit . AfterClass ; import org . junit . Assert ; import org . junit . BeforeClass ; import org . junit . Test ; import org . apache . cassandra . SchemaLoader ; import org . apache . cassandra . db . Keyspace ; import org . apache . cassandra . exceptions . ConfigurationException ; import org . apache . cassandra . gms . ApplicationState ; import org . apache . cassandra . gms . Gossiper ; import org . apache . cassandra . gms . VersionedValue ; import org . apache . cassandra . net . MessagingService ; import org . apache . cassandra . net . OutboundTcpConnectionPool ; import org . apache . cassandra . service . StorageService ; import static org . junit . Assert . assertEquals ; public class EC2SnitchTest { private static String az ; @BeforeClass public static void setup ( ) throws Exception { SchemaLoader . mkdirs ( ) ; SchemaLoader . cleanup ( ) ; Keyspace . setInitialized ( ) ; StorageService . instance . initServer ( <int> ) ; } private class TestEC2Snitch extends Ec2Snitch { public TestEC2Snitch ( ) throws IOException , ConfigurationException { super ( ) ; } @Override String awsApiCall ( String url ) throws IOException , ConfigurationException { return az ; } } @Test public void testRac ( ) throws IOException , ConfigurationException { az = <str> ; Ec2Snitch snitch = new TestEC2Snitch ( ) ; InetAddress local = InetAddress . getByName ( <str> ) ; InetAddress nonlocal = InetAddress . getByName ( <str> ) ; Gossiper . instance . addSavedEndpoint ( nonlocal ) ; Map < ApplicationState , VersionedValue > stateMap = new EnumMap < > ( ApplicationState . class ) ; stateMap . put ( ApplicationState . DC , StorageService . instance . valueFactory . datacenter ( <str> ) ) ; stateMap . put ( ApplicationState . RACK , StorageService . instance . valueFactory . datacenter ( <str> ) ) ; Gossiper . instance . getEndpointStateForEndpoint ( nonlocal ) . addApplicationStates ( stateMap ) ; assertEquals ( <str> , snitch . getDatacenter ( nonlocal ) ) ; assertEquals ( <str> , snitch . getRack ( nonlocal ) ) ; assertEquals ( <str> , snitch . getDatacenter ( local ) ) ; assertEquals ( <str> , snitch . getRack ( local ) ) ; } @Test public void testNewRegions ( ) throws IOException , ConfigurationException { az = <str> ; Ec2Snitch snitch = new TestEC2Snitch ( ) ; InetAddress local = InetAddress . getByName ( <str> ) ; assertEquals ( <str> , snitch . getDatacenter ( local ) ) ; assertEquals ( <str> , snitch . getRack ( local ) ) ; } @Test public void testEc2MRSnitch ( ) throws UnknownHostException { InetAddress me = InetAddress . getByName ( <str> ) ; InetAddress com_ip = InetAddress . getByName ( <str> ) ; OutboundTcpConnectionPool pool = MessagingService . instance ( ) . getConnectionPool ( me ) ; Assert . assertEquals ( me , pool . endPoint ( ) ) ; pool . reset ( com_ip ) ; Assert . assertEquals ( com_ip , pool . endPoint ( ) ) ; MessagingService . instance ( ) . destroyConnectionPool ( me ) ; pool = MessagingService . instance ( ) . getConnectionPool ( me ) ; Assert . assertEquals ( com_ip , pool . endPoint ( ) ) ; } @AfterClass public static void tearDown ( ) { StorageService . instance . stopClient ( ) ; } } 
