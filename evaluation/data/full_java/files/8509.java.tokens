package org . elasticsearch . search . geo ; import org . elasticsearch . Version ; import org . elasticsearch . action . search . SearchResponse ; import org . elasticsearch . cluster . metadata . IndexMetaData ; import org . elasticsearch . common . settings . Settings ; import org . elasticsearch . common . xcontent . XContentBuilder ; import org . elasticsearch . common . xcontent . XContentFactory ; import org . elasticsearch . index . query . GeoValidationMethod ; import org . elasticsearch . search . SearchHit ; import org . elasticsearch . test . ESIntegTestCase ; import org . elasticsearch . test . VersionUtils ; import static org . elasticsearch . common . xcontent . XContentFactory . jsonBuilder ; import static org . elasticsearch . index . query . QueryBuilders . boolQuery ; import static org . elasticsearch . index . query . QueryBuilders . geoBoundingBoxQuery ; import static org . elasticsearch . index . query . QueryBuilders . termQuery ; import static org . elasticsearch . test . hamcrest . ElasticsearchAssertions . assertAcked ; import static org . hamcrest . Matchers . anyOf ; import static org . hamcrest . Matchers . equalTo ; public class GeoBoundingBoxIT extends ESIntegTestCase { public void testSimpleBoundingBoxTest ( ) throws Exception { Version version = VersionUtils . randomVersionBetween ( random ( ) , Version . V_2_0_0 , Version . CURRENT ) ; Settings settings = Settings . settingsBuilder ( ) . put ( IndexMetaData . SETTING_VERSION_CREATED , version ) . build ( ) ; XContentBuilder xContentBuilder = XContentFactory . jsonBuilder ( ) . startObject ( ) . startObject ( <str> ) . startObject ( <str> ) . startObject ( <str> ) . field ( <str> , <str> ) ; if ( version . before ( Version . V_2_2_0 ) ) { xContentBuilder . field ( <str> , true ) ; } xContentBuilder . endObject ( ) . endObject ( ) . endObject ( ) . endObject ( ) ; assertAcked ( prepareCreate ( <str> ) . setSettings ( settings ) . addMapping ( <str> , xContentBuilder ) ) ; ensureGreen ( ) ; client ( ) . prepareIndex ( <str> , <str> , <str> ) . setSource ( jsonBuilder ( ) . startObject ( ) . field ( <str> , <str> ) . startObject ( <str> ) . field ( <str> , <float> ) . field ( <str> , - <float> ) . endObject ( ) . endObject ( ) ) . execute ( ) . actionGet ( ) ; client ( ) . prepareIndex ( <str> , <str> , <str> ) . setSource ( jsonBuilder ( ) . startObject ( ) . field ( <str> , <str> ) . startObject ( <str> ) . field ( <str> , <float> ) . field ( <str> , - <float> ) . endObject ( ) . endObject ( ) ) . execute ( ) . actionGet ( ) ; client ( ) . prepareIndex ( <str> , <str> , <str> ) . setSource ( jsonBuilder ( ) . startObject ( ) . field ( <str> , <str> ) . startObject ( <str> ) . field ( <str> , <float> ) . field ( <str> , - <float> ) . endObject ( ) . endObject ( ) ) . execute ( ) . actionGet ( ) ; client ( ) . prepareIndex ( <str> , <str> , <str> ) . setSource ( jsonBuilder ( ) . startObject ( ) . field ( <str> , <str> ) . startObject ( <str> ) . field ( <str> , <float> ) . field ( <str> , - <float> ) . endObject ( ) . endObject ( ) ) . execute ( ) . actionGet ( ) ; client ( ) . prepareIndex ( <str> , <str> , <str> ) . setSource ( jsonBuilder ( ) . startObject ( ) . field ( <str> , <str> ) . startObject ( <str> ) . field ( <str> , <float> ) . field ( <str> , - <int> ) . endObject ( ) . endObject ( ) ) . execute ( ) . actionGet ( ) ; client ( ) . prepareIndex ( <str> , <str> , <str> ) . setSource ( jsonBuilder ( ) . startObject ( ) . field ( <str> , <str> ) . startObject ( <str> ) . field ( <str> , <float> ) . field ( <str> , - <float> ) . endObject ( ) . endObject ( ) ) . execute ( ) . actionGet ( ) ; client ( ) . prepareIndex ( <str> , <str> , <str> ) . setSource ( jsonBuilder ( ) . startObject ( ) . field ( <str> , <str> ) . startObject ( <str> ) . field ( <str> , <float> ) . field ( <str> , - <float> ) . endObject ( ) . endObject ( ) ) . execute ( ) . actionGet ( ) ; client ( ) . admin ( ) . indices ( ) . prepareRefresh ( ) . execute ( ) . actionGet ( ) ; SearchResponse searchResponse = client ( ) . prepareSearch ( ) . setQuery ( geoBoundingBoxQuery ( <str> ) . setCorners ( <float> , - <float> , <float> , - <float> ) ) . execute ( ) . actionGet ( ) ; assertThat ( searchResponse . getHits ( ) . getTotalHits ( ) , equalTo ( <int> ) ) ; assertThat ( searchResponse . getHits ( ) . hits ( ) . length , equalTo ( <int> ) ) ; for ( SearchHit hit : searchResponse . getHits ( ) ) { assertThat ( hit . id ( ) , anyOf ( equalTo ( <str> ) , equalTo ( <str> ) , equalTo ( <str> ) ) ) ; } searchResponse = client ( ) . prepareSearch ( ) . setQuery ( geoBoundingBoxQuery ( <str> ) . setCorners ( <float> , - <float> , <float> , - <float> ) . type ( <str> ) ) . execute ( ) . actionGet ( ) ; assertThat ( searchResponse . getHits ( ) . getTotalHits ( ) , equalTo ( <int> ) ) ; assertThat ( searchResponse . getHits ( ) . hits ( ) . length , equalTo ( <int> ) ) ; for ( SearchHit hit : searchResponse . getHits ( ) ) { assertThat ( hit . id ( ) , anyOf ( equalTo ( <str> ) , equalTo ( <str> ) , equalTo ( <str> ) ) ) ; } } public void testLimitsBoundingBox ( ) throws Exception { Version version = VersionUtils . randomVersionBetween ( random ( ) , Version . V_2_0_0 , Version . CURRENT ) ; Settings settings = Settings . settingsBuilder ( ) . put ( IndexMetaData . SETTING_VERSION_CREATED , version ) . build ( ) ; XContentBuilder xContentBuilder = XContentFactory . jsonBuilder ( ) . startObject ( ) . startObject ( <str> ) . startObject ( <str> ) . startObject ( <str> ) . field ( <str> , <str> ) ; if ( version . before ( Version . V_2_2_0 ) ) { xContentBuilder . field ( <str> , true ) ; } xContentBuilder . endObject ( ) . endObject ( ) . endObject ( ) . endObject ( ) ; assertAcked ( prepareCreate ( <str> ) . setSettings ( settings ) . addMapping ( <str> , xContentBuilder ) ) ; ensureGreen ( ) ; client ( ) . prepareIndex ( <str> , <str> , <str> ) . setSource ( jsonBuilder ( ) . startObject ( ) . startObject ( <str> ) . field ( <str> , <int> ) . field ( <str> , - <int> ) . endObject ( ) . endObject ( ) ) . execute ( ) . actionGet ( ) ; client ( ) . prepareIndex ( <str> , <str> , <str> ) . setSource ( jsonBuilder ( ) . startObject ( ) . startObject ( <str> ) . field ( <str> , <int> ) . field ( <str> , - <int> ) . endObject ( ) . endObject ( ) ) . execute ( ) . actionGet ( ) ; client ( ) . prepareIndex ( <str> , <str> , <str> ) . setSource ( jsonBuilder ( ) . startObject ( ) . startObject ( <str> ) . field ( <str> , <int> ) . field ( <str> , <int> ) . endObject ( ) . endObject ( ) ) . execute ( ) . actionGet ( ) ; client ( ) . prepareIndex ( <str> , <str> , <str> ) . setSource ( jsonBuilder ( ) . startObject ( ) . startObject ( <str> ) . field ( <str> , <int> ) . field ( <str> , <int> ) . endObject ( ) . endObject ( ) ) . execute ( ) . actionGet ( ) ; client ( ) . prepareIndex ( <str> , <str> , <str> ) . setSource ( jsonBuilder ( ) . startObject ( ) . startObject ( <str> ) . field ( <str> , <int> ) . field ( <str> , - <int> ) . endObject ( ) . endObject ( ) ) . execute ( ) . actionGet ( ) ; client ( ) . prepareIndex ( <str> , <str> , <str> ) . setSource ( jsonBuilder ( ) . startObject ( ) . startObject ( <str> ) . field ( <str> , <int> ) . field ( <str> , - <int> ) . endObject ( ) . endObject ( ) ) . execute ( ) . actionGet ( ) ; client ( ) . prepareIndex ( <str> , <str> , <str> ) . setSource ( jsonBuilder ( ) . startObject ( ) . startObject ( <str> ) . field ( <str> , - <int> ) . field ( <str> , - <int> ) . endObject ( ) . endObject ( ) ) . execute ( ) . actionGet ( ) ; client ( ) . prepareIndex ( <str> , <str> , <str> ) . setSource ( jsonBuilder ( ) . startObject ( ) . startObject ( <str> ) . field ( <str> , <int> ) . field ( <str> , <int> ) . endObject ( ) . endObject ( ) ) . execute ( ) . actionGet ( ) ; client ( ) . prepareIndex ( <str> , <str> , <str> ) . setSource ( jsonBuilder ( ) . startObject ( ) . startObject ( <str> ) . field ( <str> , <int> ) . field ( <str> , <int> ) . endObject ( ) . endObject ( ) ) . execute ( ) . actionGet ( ) ; client ( ) . prepareIndex ( <str> , <str> , <str> ) . setSource ( jsonBuilder ( ) . startObject ( ) . startObject ( <str> ) . field ( <str> , - <int> ) . field ( <str> , <int> ) . endObject ( ) . endObject ( ) ) . execute ( ) . actionGet ( ) ; refresh ( ) ; SearchResponse searchResponse = client ( ) . prepareSearch ( ) . setQuery ( geoBoundingBoxQuery ( <str> ) . setCorners ( <int> , - <int> , <int> , <int> ) ) . execute ( ) . actionGet ( ) ; assertThat ( searchResponse . getHits ( ) . getTotalHits ( ) , equalTo ( <int> ) ) ; assertThat ( searchResponse . getHits ( ) . hits ( ) . length , equalTo ( <int> ) ) ; assertThat ( searchResponse . getHits ( ) . getAt ( <int> ) . id ( ) , equalTo ( <str> ) ) ; searchResponse = client ( ) . prepareSearch ( ) . setQuery ( geoBoundingBoxQuery ( <str> ) . setCorners ( <int> , - <int> , <int> , <int> ) . type ( <str> ) ) . execute ( ) . actionGet ( ) ; assertThat ( searchResponse . getHits ( ) . getTotalHits ( ) , equalTo ( <int> ) ) ; assertThat ( searchResponse . getHits ( ) . hits ( ) . length , equalTo ( <int> ) ) ; assertThat ( searchResponse . getHits ( ) . getAt ( <int> ) . id ( ) , equalTo ( <str> ) ) ; searchResponse = client ( ) . prepareSearch ( ) . setQuery ( geoBoundingBoxQuery ( <str> ) . setCorners ( <int> , - <int> , <int> , <int> ) ) . execute ( ) . actionGet ( ) ; assertThat ( searchResponse . getHits ( ) . getTotalHits ( ) , equalTo ( <int> ) ) ; assertThat ( searchResponse . getHits ( ) . hits ( ) . length , equalTo ( <int> ) ) ; assertThat ( searchResponse . getHits ( ) . getAt ( <int> ) . id ( ) , equalTo ( <str> ) ) ; searchResponse = client ( ) . prepareSearch ( ) . setQuery ( geoBoundingBoxQuery ( <str> ) . setCorners ( <int> , - <int> , <int> , <int> ) . type ( <str> ) ) . execute ( ) . actionGet ( ) ; assertThat ( searchResponse . getHits ( ) . getTotalHits ( ) , equalTo ( <int> ) ) ; assertThat ( searchResponse . getHits ( ) . hits ( ) . length , equalTo ( <int> ) ) ; assertThat ( searchResponse . getHits ( ) . getAt ( <int> ) . id ( ) , equalTo ( <str> ) ) ; searchResponse = client ( ) . prepareSearch ( ) . setQuery ( geoBoundingBoxQuery ( <str> ) . setCorners ( <int> , <int> , <int> , - <int> ) ) . execute ( ) . actionGet ( ) ; assertThat ( searchResponse . getHits ( ) . getTotalHits ( ) , equalTo ( <int> ) ) ; assertThat ( searchResponse . getHits ( ) . hits ( ) . length , equalTo ( <int> ) ) ; assertThat ( searchResponse . getHits ( ) . getAt ( <int> ) . id ( ) , equalTo ( <str> ) ) ; searchResponse = client ( ) . prepareSearch ( ) . setQuery ( geoBoundingBoxQuery ( <str> ) . setCorners ( <int> , <int> , <int> , - <int> ) . type ( <str> ) ) . execute ( ) . actionGet ( ) ; assertThat ( searchResponse . getHits ( ) . getTotalHits ( ) , equalTo ( <int> ) ) ; assertThat ( searchResponse . getHits ( ) . hits ( ) . length , equalTo ( <int> ) ) ; assertThat ( searchResponse . getHits ( ) . getAt ( <int> ) . id ( ) , equalTo ( <str> ) ) ; searchResponse = client ( ) . prepareSearch ( ) . setQuery ( geoBoundingBoxQuery ( <str> ) . setCorners ( <int> , <int> , - <int> , - <int> ) ) . execute ( ) . actionGet ( ) ; assertThat ( searchResponse . getHits ( ) . getTotalHits ( ) , equalTo ( <int> ) ) ; assertThat ( searchResponse . getHits ( ) . hits ( ) . length , equalTo ( <int> ) ) ; assertThat ( searchResponse . getHits ( ) . getAt ( <int> ) . id ( ) , equalTo ( <str> ) ) ; searchResponse = client ( ) . prepareSearch ( ) . setQuery ( geoBoundingBoxQuery ( <str> ) . setCorners ( <int> , <int> , - <int> , - <int> ) . type ( <str> ) ) . execute ( ) . actionGet ( ) ; assertThat ( searchResponse . getHits ( ) . getTotalHits ( ) , equalTo ( <int> ) ) ; assertThat ( searchResponse . getHits ( ) . hits ( ) . length , equalTo ( <int> ) ) ; assertThat ( searchResponse . getHits ( ) . getAt ( <int> ) . id ( ) , equalTo ( <str> ) ) ; } public void testLimit2BoundingBox ( ) throws Exception { Version version = VersionUtils . randomVersionBetween ( random ( ) , Version . V_2_0_0 , Version . CURRENT ) ; Settings settings = Settings . settingsBuilder ( ) . put ( IndexMetaData . SETTING_VERSION_CREATED , version ) . build ( ) ; XContentBuilder xContentBuilder = XContentFactory . jsonBuilder ( ) . startObject ( ) . startObject ( <str> ) . startObject ( <str> ) . startObject ( <str> ) . field ( <str> , <str> ) ; if ( version . before ( Version . V_2_2_0 ) ) { xContentBuilder . field ( <str> , true ) ; } xContentBuilder . endObject ( ) . endObject ( ) . endObject ( ) . endObject ( ) ; assertAcked ( prepareCreate ( <str> ) . setSettings ( settings ) . addMapping ( <str> , xContentBuilder ) ) ; ensureGreen ( ) ; client ( ) . prepareIndex ( <str> , <str> , <str> ) . setSource ( jsonBuilder ( ) . startObject ( ) . field ( <str> , <int> ) . field ( <str> , <str> ) . startObject ( <str> ) . field ( <str> , <float> ) . field ( <str> , <float> ) . endObject ( ) . endObject ( ) ) . setRefresh ( true ) . execute ( ) . actionGet ( ) ; client ( ) . prepareIndex ( <str> , <str> , <str> ) . setSource ( jsonBuilder ( ) . startObject ( ) . field ( <str> , <int> ) . field ( <str> , <str> ) . startObject ( <str> ) . field ( <str> , <float> ) . field ( <str> , - <float> ) . endObject ( ) . endObject ( ) ) . setRefresh ( true ) . execute ( ) . actionGet ( ) ; SearchResponse searchResponse = client ( ) . prepareSearch ( ) . setQuery ( boolQuery ( ) . must ( termQuery ( <str> , <int> ) ) . filter ( geoBoundingBoxQuery ( <str> ) . setCorners ( <float> , <float> , - <float> , <float> ) ) ) . execute ( ) . actionGet ( ) ; assertThat ( searchResponse . getHits ( ) . totalHits ( ) , equalTo ( <int> ) ) ; searchResponse = client ( ) . prepareSearch ( ) . setQuery ( boolQuery ( ) . must ( termQuery ( <str> , <int> ) ) . filter ( geoBoundingBoxQuery ( <str> ) . setCorners ( <float> , <float> , - <float> , <float> ) . type ( <str> ) ) ) . execute ( ) . actionGet ( ) ; assertThat ( searchResponse . getHits ( ) . totalHits ( ) , equalTo ( <int> ) ) ; searchResponse = client ( ) . prepareSearch ( ) . setQuery ( boolQuery ( ) . must ( termQuery ( <str> , <int> ) ) . filter ( geoBoundingBoxQuery ( <str> ) . setCorners ( <float> , <float> , - <float> , <float> ) ) ) . execute ( ) . actionGet ( ) ; assertThat ( searchResponse . getHits ( ) . totalHits ( ) , equalTo ( <int> ) ) ; searchResponse = client ( ) . prepareSearch ( ) . setQuery ( boolQuery ( ) . must ( termQuery ( <str> , <int> ) ) . filter ( geoBoundingBoxQuery ( <str> ) . setCorners ( <float> , <float> , - <float> , <float> ) . type ( <str> ) ) ) . execute ( ) . actionGet ( ) ; assertThat ( searchResponse . getHits ( ) . totalHits ( ) , equalTo ( <int> ) ) ; } public void testCompleteLonRange ( ) throws Exception { Version version = VersionUtils . randomVersionBetween ( random ( ) , Version . V_2_0_0 , Version . CURRENT ) ; Settings settings = Settings . settingsBuilder ( ) . put ( IndexMetaData . SETTING_VERSION_CREATED , version ) . build ( ) ; XContentBuilder xContentBuilder = XContentFactory . jsonBuilder ( ) . startObject ( ) . startObject ( <str> ) . startObject ( <str> ) . startObject ( <str> ) . field ( <str> , <str> ) ; if ( version . before ( Version . V_2_2_0 ) ) { xContentBuilder . field ( <str> , true ) ; } xContentBuilder . endObject ( ) . endObject ( ) . endObject ( ) . endObject ( ) ; assertAcked ( prepareCreate ( <str> ) . setSettings ( settings ) . addMapping ( <str> , xContentBuilder ) ) ; ensureGreen ( ) ; client ( ) . prepareIndex ( <str> , <str> , <str> ) . setSource ( jsonBuilder ( ) . startObject ( ) . field ( <str> , <int> ) . field ( <str> , <str> ) . startObject ( <str> ) . field ( <str> , <float> ) . field ( <str> , <float> ) . endObject ( ) . endObject ( ) ) . setRefresh ( true ) . execute ( ) . actionGet ( ) ; client ( ) . prepareIndex ( <str> , <str> , <str> ) . setSource ( jsonBuilder ( ) . startObject ( ) . field ( <str> , <int> ) . field ( <str> , <str> ) . startObject ( <str> ) . field ( <str> , <float> ) . field ( <str> , - <float> ) . endObject ( ) . endObject ( ) ) . setRefresh ( true ) . execute ( ) . actionGet ( ) ; SearchResponse searchResponse = client ( ) . prepareSearch ( ) . setQuery ( geoBoundingBoxQuery ( <str> ) . setValidationMethod ( GeoValidationMethod . COERCE ) . setCorners ( <int> , - <int> , - <int> , <int> ) ) . execute ( ) . actionGet ( ) ; assertThat ( searchResponse . getHits ( ) . totalHits ( ) , equalTo ( <int> ) ) ; searchResponse = client ( ) . prepareSearch ( ) . setQuery ( geoBoundingBoxQuery ( <str> ) . setValidationMethod ( GeoValidationMethod . COERCE ) . setCorners ( <int> , - <int> , - <int> , <int> ) . type ( <str> ) ) . execute ( ) . actionGet ( ) ; assertThat ( searchResponse . getHits ( ) . totalHits ( ) , equalTo ( <int> ) ) ; searchResponse = client ( ) . prepareSearch ( ) . setQuery ( geoBoundingBoxQuery ( <str> ) . setValidationMethod ( GeoValidationMethod . COERCE ) . setCorners ( <int> , - <int> , - <int> , <int> ) ) . execute ( ) . actionGet ( ) ; assertThat ( searchResponse . getHits ( ) . totalHits ( ) , equalTo ( <int> ) ) ; searchResponse = client ( ) . prepareSearch ( ) . setQuery ( geoBoundingBoxQuery ( <str> ) . setValidationMethod ( GeoValidationMethod . COERCE ) . setCorners ( <int> , - <int> , - <int> , <int> ) . type ( <str> ) ) . execute ( ) . actionGet ( ) ; assertThat ( searchResponse . getHits ( ) . totalHits ( ) , equalTo ( <int> ) ) ; searchResponse = client ( ) . prepareSearch ( ) . setQuery ( geoBoundingBoxQuery ( <str> ) . setValidationMethod ( GeoValidationMethod . COERCE ) . setCorners ( <int> , <int> , - <int> , <int> ) ) . execute ( ) . actionGet ( ) ; assertThat ( searchResponse . getHits ( ) . totalHits ( ) , equalTo ( <int> ) ) ; searchResponse = client ( ) . prepareSearch ( ) . setQuery ( geoBoundingBoxQuery ( <str> ) . setValidationMethod ( GeoValidationMethod . COERCE ) . setCorners ( <int> , <int> , - <int> , <int> ) . type ( <str> ) ) . execute ( ) . actionGet ( ) ; assertThat ( searchResponse . getHits ( ) . totalHits ( ) , equalTo ( <int> ) ) ; searchResponse = client ( ) . prepareSearch ( ) . setQuery ( geoBoundingBoxQuery ( <str> ) . setValidationMethod ( GeoValidationMethod . COERCE ) . setCorners ( <int> , <int> , - <int> , <int> ) ) . execute ( ) . actionGet ( ) ; assertThat ( searchResponse . getHits ( ) . totalHits ( ) , equalTo ( <int> ) ) ; searchResponse = client ( ) . prepareSearch ( ) . setQuery ( geoBoundingBoxQuery ( <str> ) . setValidationMethod ( GeoValidationMethod . COERCE ) . setCorners ( <int> , <int> , - <int> , <int> ) . type ( <str> ) ) . execute ( ) . actionGet ( ) ; assertThat ( searchResponse . getHits ( ) . totalHits ( ) , equalTo ( <int> ) ) ; } } 
