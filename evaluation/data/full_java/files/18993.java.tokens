package io . netty . handler . codec . frame ; import io . netty . buffer . ByteBuf ; import io . netty . buffer . Unpooled ; import io . netty . channel . embedded . EmbeddedChannel ; import io . netty . handler . codec . DecoderException ; import io . netty . handler . codec . LengthFieldBasedFrameDecoder ; import io . netty . handler . codec . TooLongFrameException ; import io . netty . util . CharsetUtil ; import org . junit . Test ; import static io . netty . util . ReferenceCountUtil . releaseLater ; import static org . junit . Assert . * ; public class LengthFieldBasedFrameDecoderTest { @Test public void testFailSlowTooLongFrameRecovery ( ) throws Exception { EmbeddedChannel ch = new EmbeddedChannel ( new LengthFieldBasedFrameDecoder ( <int> , <int> , <int> , <int> , <int> , false ) ) ; for ( int i = <int> ; i < <int> ; i + + ) { assertFalse ( ch . writeInbound ( Unpooled . wrappedBuffer ( new byte [ ] { <int> , <int> , <int> , <int> } ) ) ) ; try { assertTrue ( ch . writeInbound ( Unpooled . wrappedBuffer ( new byte [ ] { <int> , <int> } ) ) ) ; fail ( DecoderException . class . getSimpleName ( ) + <str> ) ; } catch ( TooLongFrameException e ) { } ch . writeInbound ( Unpooled . wrappedBuffer ( new byte [ ] { <int> , <int> , <int> , <int> , <str> } ) ) ; ByteBuf buf = releaseLater ( ( ByteBuf ) ch . readInbound ( ) ) ; assertEquals ( <str> , buf . toString ( CharsetUtil . ISO_8859_1 ) ) ; buf . release ( ) ; } } @Test public void testFailFastTooLongFrameRecovery ( ) throws Exception { EmbeddedChannel ch = new EmbeddedChannel ( new LengthFieldBasedFrameDecoder ( <int> , <int> , <int> , <int> , <int> ) ) ; for ( int i = <int> ; i < <int> ; i + + ) { try { assertTrue ( ch . writeInbound ( Unpooled . wrappedBuffer ( new byte [ ] { <int> , <int> , <int> , <int> } ) ) ) ; fail ( DecoderException . class . getSimpleName ( ) + <str> ) ; } catch ( TooLongFrameException e ) { } ch . writeInbound ( Unpooled . wrappedBuffer ( new byte [ ] { <int> , <int> , <int> , <int> , <int> , <int> , <str> } ) ) ; ByteBuf buf = releaseLater ( ( ByteBuf ) ch . readInbound ( ) ) ; assertEquals ( <str> , buf . toString ( CharsetUtil . ISO_8859_1 ) ) ; buf . release ( ) ; } } } 
