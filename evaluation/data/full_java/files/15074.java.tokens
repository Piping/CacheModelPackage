package org . gradle . nativeplatform . toolchain . internal . msvcpp ; import org . gradle . api . Transformer ; import org . gradle . api . internal . tasks . SimpleWorkResult ; import org . gradle . internal . operations . BuildOperationProcessor ; import org . gradle . internal . operations . BuildOperationQueue ; import org . gradle . language . base . internal . compile . Compiler ; import org . gradle . api . tasks . WorkResult ; import org . gradle . nativeplatform . internal . LinkerSpec ; import org . gradle . nativeplatform . internal . SharedLibraryLinkerSpec ; import org . gradle . nativeplatform . toolchain . internal . * ; import java . io . File ; import java . util . ArrayList ; import java . util . List ; import static org . gradle . nativeplatform . toolchain . internal . msvcpp . EscapeUserArgs . escapeUserArgs ; class LinkExeLinker implements Compiler < LinkerSpec > { private final CommandLineToolInvocationWorker commandLineToolInvocationWorker ; private final Transformer < LinkerSpec , LinkerSpec > specTransformer ; private final ArgsTransformer < LinkerSpec > argsTransformer ; private final CommandLineToolContext invocationContext ; private final BuildOperationProcessor buildOperationProcessor ; LinkExeLinker ( BuildOperationProcessor buildOperationProcessor , CommandLineToolInvocationWorker commandLineToolInvocationWorker , CommandLineToolContext invocationContext , Transformer < LinkerSpec , LinkerSpec > specTransformer ) { this . buildOperationProcessor = buildOperationProcessor ; this . argsTransformer = new LinkerArgsTransformer ( ) ; this . commandLineToolInvocationWorker = commandLineToolInvocationWorker ; this . invocationContext = invocationContext ; this . specTransformer = specTransformer ; } public WorkResult execute ( LinkerSpec spec ) { BuildOperationQueue < CommandLineToolInvocation > queue = buildOperationProcessor . newQueue ( commandLineToolInvocationWorker , spec . getOperationLogger ( ) . getLogLocation ( ) ) ; LinkerSpec transformedSpec = specTransformer . transform ( spec ) ; List < String > args = argsTransformer . transform ( transformedSpec ) ; invocationContext . getArgAction ( ) . execute ( args ) ; new VisualCppOptionsFileArgsWriter ( spec . getTempDir ( ) ) . execute ( args ) ; CommandLineToolInvocation invocation = invocationContext . createInvocation ( String . format ( <str> , spec . getOutputFile ( ) . getName ( ) ) , args , spec . getOperationLogger ( ) ) ; queue . add ( invocation ) ; queue . waitForCompletion ( ) ; return new SimpleWorkResult ( true ) ; } private static class LinkerArgsTransformer implements ArgsTransformer < LinkerSpec > { public List < String > transform ( LinkerSpec spec ) { List < String > args = new ArrayList < String > ( ) ; args . addAll ( escapeUserArgs ( spec . getAllArgs ( ) ) ) ; args . add ( <str> + spec . getOutputFile ( ) . getAbsolutePath ( ) ) ; args . add ( <str> ) ; if ( spec instanceof SharedLibraryLinkerSpec ) { args . add ( <str> ) ; } for ( File pathEntry : spec . getLibraryPath ( ) ) { args . add ( <str> + pathEntry . getAbsolutePath ( ) ) ; } for ( File file : spec . getObjectFiles ( ) ) { args . add ( file . getAbsolutePath ( ) ) ; } for ( File file : spec . getLibraries ( ) ) { args . add ( file . getAbsolutePath ( ) ) ; } return args ; } } } 
