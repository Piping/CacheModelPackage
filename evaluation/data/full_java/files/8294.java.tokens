package org . elasticsearch . index . shard ; import org . apache . lucene . index . NoMergePolicy ; import org . apache . lucene . index . TieredMergePolicy ; import org . elasticsearch . common . settings . Settings ; import org . elasticsearch . common . unit . ByteSizeUnit ; import org . elasticsearch . common . unit . ByteSizeValue ; import org . elasticsearch . index . Index ; import org . elasticsearch . test . ESTestCase ; import java . io . IOException ; import static org . elasticsearch . common . settings . Settings . Builder . EMPTY_SETTINGS ; import static org . hamcrest . Matchers . equalTo ; public class MergePolicySettingsTests extends ESTestCase { protected final ShardId shardId = new ShardId ( new Index ( <str> ) , <int> ) ; public void testCompoundFileSettings ( ) throws IOException { assertThat ( new MergePolicyConfig ( logger , EMPTY_SETTINGS ) . getMergePolicy ( ) . getNoCFSRatio ( ) , equalTo ( <float> ) ) ; assertThat ( new MergePolicyConfig ( logger , build ( true ) ) . getMergePolicy ( ) . getNoCFSRatio ( ) , equalTo ( <float> ) ) ; assertThat ( new MergePolicyConfig ( logger , build ( <float> ) ) . getMergePolicy ( ) . getNoCFSRatio ( ) , equalTo ( <float> ) ) ; assertThat ( new MergePolicyConfig ( logger , build ( <float> ) ) . getMergePolicy ( ) . getNoCFSRatio ( ) , equalTo ( <float> ) ) ; assertThat ( new MergePolicyConfig ( logger , build ( <str> ) ) . getMergePolicy ( ) . getNoCFSRatio ( ) , equalTo ( <float> ) ) ; assertThat ( new MergePolicyConfig ( logger , build ( <str> ) ) . getMergePolicy ( ) . getNoCFSRatio ( ) , equalTo ( <float> ) ) ; assertThat ( new MergePolicyConfig ( logger , build ( <str> ) ) . getMergePolicy ( ) . getNoCFSRatio ( ) , equalTo ( <float> ) ) ; assertThat ( new MergePolicyConfig ( logger , build ( <str> ) ) . getMergePolicy ( ) . getNoCFSRatio ( ) , equalTo ( <float> ) ) ; assertThat ( new MergePolicyConfig ( logger , build ( false ) ) . getMergePolicy ( ) . getNoCFSRatio ( ) , equalTo ( <float> ) ) ; assertThat ( new MergePolicyConfig ( logger , build ( <int> ) ) . getMergePolicy ( ) . getNoCFSRatio ( ) , equalTo ( <float> ) ) ; assertThat ( new MergePolicyConfig ( logger , build ( <float> ) ) . getMergePolicy ( ) . getNoCFSRatio ( ) , equalTo ( <float> ) ) ; } public void testNoMerges ( ) { MergePolicyConfig mp = new MergePolicyConfig ( logger , Settings . builder ( ) . put ( MergePolicyConfig . INDEX_MERGE_ENABLED , false ) . build ( ) ) ; assertTrue ( mp . getMergePolicy ( ) instanceof NoMergePolicy ) ; } public void testUpdateSettings ( ) throws IOException { { MergePolicyConfig mp = new MergePolicyConfig ( logger , EMPTY_SETTINGS ) ; assertThat ( ( mp . getMergePolicy ( ) ) . getNoCFSRatio ( ) , equalTo ( <float> ) ) ; mp . onRefreshSettings ( build ( <float> ) ) ; assertThat ( ( mp . getMergePolicy ( ) ) . getNoCFSRatio ( ) , equalTo ( <float> ) ) ; mp . onRefreshSettings ( build ( <float> ) ) ; assertThat ( ( mp . getMergePolicy ( ) ) . getNoCFSRatio ( ) , equalTo ( <float> ) ) ; mp . onRefreshSettings ( build ( <float> ) ) ; assertThat ( ( mp . getMergePolicy ( ) ) . getNoCFSRatio ( ) , equalTo ( <float> ) ) ; } } public void testTieredMergePolicySettingsUpdate ( ) throws IOException { MergePolicyConfig mp = new MergePolicyConfig ( logger , EMPTY_SETTINGS ) ; assertThat ( mp . getMergePolicy ( ) . getNoCFSRatio ( ) , equalTo ( <float> ) ) ; assertEquals ( ( ( TieredMergePolicy ) mp . getMergePolicy ( ) ) . getForceMergeDeletesPctAllowed ( ) , MergePolicyConfig . DEFAULT_EXPUNGE_DELETES_ALLOWED , <float> ) ; mp . onRefreshSettings ( Settings . builder ( ) . put ( MergePolicyConfig . INDEX_MERGE_POLICY_EXPUNGE_DELETES_ALLOWED , MergePolicyConfig . DEFAULT_EXPUNGE_DELETES_ALLOWED + <float> ) . build ( ) ) ; assertEquals ( ( ( TieredMergePolicy ) mp . getMergePolicy ( ) ) . getForceMergeDeletesPctAllowed ( ) , MergePolicyConfig . DEFAULT_EXPUNGE_DELETES_ALLOWED + <float> , <float> ) ; assertEquals ( ( ( TieredMergePolicy ) mp . getMergePolicy ( ) ) . getFloorSegmentMB ( ) , MergePolicyConfig . DEFAULT_FLOOR_SEGMENT . mbFrac ( ) , <int> ) ; mp . onRefreshSettings ( Settings . builder ( ) . put ( MergePolicyConfig . INDEX_MERGE_POLICY_FLOOR_SEGMENT , new ByteSizeValue ( MergePolicyConfig . DEFAULT_FLOOR_SEGMENT . mb ( ) + <int> , ByteSizeUnit . MB ) ) . build ( ) ) ; assertEquals ( ( ( TieredMergePolicy ) mp . getMergePolicy ( ) ) . getFloorSegmentMB ( ) , new ByteSizeValue ( MergePolicyConfig . DEFAULT_FLOOR_SEGMENT . mb ( ) + <int> , ByteSizeUnit . MB ) . mbFrac ( ) , <float> ) ; assertEquals ( ( ( TieredMergePolicy ) mp . getMergePolicy ( ) ) . getMaxMergeAtOnce ( ) , MergePolicyConfig . DEFAULT_MAX_MERGE_AT_ONCE ) ; mp . onRefreshSettings ( Settings . builder ( ) . put ( MergePolicyConfig . INDEX_MERGE_POLICY_MAX_MERGE_AT_ONCE , MergePolicyConfig . DEFAULT_MAX_MERGE_AT_ONCE - <int> ) . build ( ) ) ; assertEquals ( ( ( TieredMergePolicy ) mp . getMergePolicy ( ) ) . getMaxMergeAtOnce ( ) , MergePolicyConfig . DEFAULT_MAX_MERGE_AT_ONCE - <int> ) ; assertEquals ( ( ( TieredMergePolicy ) mp . getMergePolicy ( ) ) . getMaxMergeAtOnceExplicit ( ) , MergePolicyConfig . DEFAULT_MAX_MERGE_AT_ONCE_EXPLICIT ) ; mp . onRefreshSettings ( Settings . builder ( ) . put ( MergePolicyConfig . INDEX_MERGE_POLICY_MAX_MERGE_AT_ONCE_EXPLICIT , MergePolicyConfig . DEFAULT_MAX_MERGE_AT_ONCE_EXPLICIT - <int> ) . build ( ) ) ; assertEquals ( ( ( TieredMergePolicy ) mp . getMergePolicy ( ) ) . getMaxMergeAtOnceExplicit ( ) , MergePolicyConfig . DEFAULT_MAX_MERGE_AT_ONCE_EXPLICIT - <int> ) ; assertEquals ( ( ( TieredMergePolicy ) mp . getMergePolicy ( ) ) . getMaxMergedSegmentMB ( ) , MergePolicyConfig . DEFAULT_MAX_MERGED_SEGMENT . mbFrac ( ) , <float> ) ; mp . onRefreshSettings ( Settings . builder ( ) . put ( MergePolicyConfig . INDEX_MERGE_POLICY_MAX_MERGED_SEGMENT , new ByteSizeValue ( MergePolicyConfig . DEFAULT_MAX_MERGED_SEGMENT . bytes ( ) + <int> ) ) . build ( ) ) ; assertEquals ( ( ( TieredMergePolicy ) mp . getMergePolicy ( ) ) . getMaxMergedSegmentMB ( ) , new ByteSizeValue ( MergePolicyConfig . DEFAULT_MAX_MERGED_SEGMENT . bytes ( ) + <int> ) . mbFrac ( ) , <float> ) ; assertEquals ( ( ( TieredMergePolicy ) mp . getMergePolicy ( ) ) . getReclaimDeletesWeight ( ) , MergePolicyConfig . DEFAULT_RECLAIM_DELETES_WEIGHT , <int> ) ; mp . onRefreshSettings ( Settings . builder ( ) . put ( MergePolicyConfig . INDEX_MERGE_POLICY_RECLAIM_DELETES_WEIGHT , MergePolicyConfig . DEFAULT_RECLAIM_DELETES_WEIGHT + <int> ) . build ( ) ) ; assertEquals ( ( ( TieredMergePolicy ) mp . getMergePolicy ( ) ) . getReclaimDeletesWeight ( ) , MergePolicyConfig . DEFAULT_RECLAIM_DELETES_WEIGHT + <int> , <int> ) ; assertEquals ( ( ( TieredMergePolicy ) mp . getMergePolicy ( ) ) . getSegmentsPerTier ( ) , MergePolicyConfig . DEFAULT_SEGMENTS_PER_TIER , <int> ) ; mp . onRefreshSettings ( Settings . builder ( ) . put ( MergePolicyConfig . INDEX_MERGE_POLICY_SEGMENTS_PER_TIER , MergePolicyConfig . DEFAULT_SEGMENTS_PER_TIER + <int> ) . build ( ) ) ; assertEquals ( ( ( TieredMergePolicy ) mp . getMergePolicy ( ) ) . getSegmentsPerTier ( ) , MergePolicyConfig . DEFAULT_SEGMENTS_PER_TIER + <int> , <int> ) ; mp . onRefreshSettings ( EMPTY_SETTINGS ) ; assertEquals ( ( ( TieredMergePolicy ) mp . getMergePolicy ( ) ) . getForceMergeDeletesPctAllowed ( ) , MergePolicyConfig . DEFAULT_EXPUNGE_DELETES_ALLOWED + <float> , <float> ) ; assertEquals ( ( ( TieredMergePolicy ) mp . getMergePolicy ( ) ) . getFloorSegmentMB ( ) , new ByteSizeValue ( MergePolicyConfig . DEFAULT_FLOOR_SEGMENT . mb ( ) + <int> , ByteSizeUnit . MB ) . mbFrac ( ) , <float> ) ; assertEquals ( ( ( TieredMergePolicy ) mp . getMergePolicy ( ) ) . getMaxMergeAtOnce ( ) , MergePolicyConfig . DEFAULT_MAX_MERGE_AT_ONCE - <int> ) ; assertEquals ( ( ( TieredMergePolicy ) mp . getMergePolicy ( ) ) . getMaxMergeAtOnceExplicit ( ) , MergePolicyConfig . DEFAULT_MAX_MERGE_AT_ONCE_EXPLICIT - <int> ) ; assertEquals ( ( ( TieredMergePolicy ) mp . getMergePolicy ( ) ) . getMaxMergedSegmentMB ( ) , new ByteSizeValue ( MergePolicyConfig . DEFAULT_MAX_MERGED_SEGMENT . bytes ( ) + <int> ) . mbFrac ( ) , <float> ) ; assertEquals ( ( ( TieredMergePolicy ) mp . getMergePolicy ( ) ) . getReclaimDeletesWeight ( ) , MergePolicyConfig . DEFAULT_RECLAIM_DELETES_WEIGHT + <int> , <int> ) ; assertEquals ( ( ( TieredMergePolicy ) mp . getMergePolicy ( ) ) . getSegmentsPerTier ( ) , MergePolicyConfig . DEFAULT_SEGMENTS_PER_TIER + <int> , <int> ) ; } public Settings build ( String value ) { return Settings . builder ( ) . put ( MergePolicyConfig . INDEX_COMPOUND_FORMAT , value ) . build ( ) ; } public Settings build ( double value ) { return Settings . builder ( ) . put ( MergePolicyConfig . INDEX_COMPOUND_FORMAT , value ) . build ( ) ; } public Settings build ( int value ) { return Settings . builder ( ) . put ( MergePolicyConfig . INDEX_COMPOUND_FORMAT , value ) . build ( ) ; } public Settings build ( boolean value ) { return Settings . builder ( ) . put ( MergePolicyConfig . INDEX_COMPOUND_FORMAT , value ) . build ( ) ; } } 
