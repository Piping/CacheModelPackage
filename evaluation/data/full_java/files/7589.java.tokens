package org . elasticsearch . search . suggest . completion ; import org . apache . lucene . search . suggest . document . FuzzyCompletionQuery ; import org . apache . lucene . util . automaton . Operations ; import org . apache . lucene . util . automaton . RegExp ; import org . elasticsearch . common . unit . Fuzziness ; import org . elasticsearch . common . xcontent . ToXContent ; import org . elasticsearch . common . xcontent . XContentBuilder ; import org . elasticsearch . index . query . RegexpFlag ; import org . elasticsearch . search . suggest . SuggestBuilder ; import org . elasticsearch . search . suggest . completion . context . CategoryQueryContext ; import org . elasticsearch . search . suggest . completion . context . GeoQueryContext ; import java . io . IOException ; import java . util . * ; import static org . elasticsearch . search . suggest . completion . context . CategoryContextMapping . * ; public class CompletionSuggestionBuilder extends SuggestBuilder . SuggestionBuilder < CompletionSuggestionBuilder > { private FuzzyOptionsBuilder fuzzyOptionsBuilder ; private RegexOptionsBuilder regexOptionsBuilder ; private final Map < String , List < ToXContent > > queryContexts = new HashMap < > ( ) ; private final Set < String > payloadFields = new HashSet < > ( ) ; public CompletionSuggestionBuilder ( String name ) { super ( name , <str> ) ; } public static class FuzzyOptionsBuilder implements ToXContent { private int editDistance = FuzzyCompletionQuery . DEFAULT_MAX_EDITS ; private boolean transpositions = FuzzyCompletionQuery . DEFAULT_TRANSPOSITIONS ; private int fuzzyMinLength = FuzzyCompletionQuery . DEFAULT_MIN_FUZZY_LENGTH ; private int fuzzyPrefixLength = FuzzyCompletionQuery . DEFAULT_NON_FUZZY_PREFIX ; private boolean unicodeAware = FuzzyCompletionQuery . DEFAULT_UNICODE_AWARE ; private int maxDeterminizedStates = Operations . DEFAULT_MAX_DETERMINIZED_STATES ; public FuzzyOptionsBuilder ( ) { } public FuzzyOptionsBuilder setFuzziness ( int editDistance ) { this . editDistance = editDistance ; return this ; } public FuzzyOptionsBuilder setFuzziness ( Fuzziness fuzziness ) { this . editDistance = fuzziness . asDistance ( ) ; return this ; } public FuzzyOptionsBuilder setTranspositions ( boolean transpositions ) { this . transpositions = transpositions ; return this ; } public FuzzyOptionsBuilder setFuzzyMinLength ( int fuzzyMinLength ) { this . fuzzyMinLength = fuzzyMinLength ; return this ; } public FuzzyOptionsBuilder setFuzzyPrefixLength ( int fuzzyPrefixLength ) { this . fuzzyPrefixLength = fuzzyPrefixLength ; return this ; } public FuzzyOptionsBuilder setMaxDeterminizedStates ( int maxDeterminizedStates ) { this . maxDeterminizedStates = maxDeterminizedStates ; return this ; } public FuzzyOptionsBuilder setUnicodeAware ( boolean unicodeAware ) { this . unicodeAware = unicodeAware ; return this ; } int getEditDistance ( ) { return editDistance ; } boolean isTranspositions ( ) { return transpositions ; } int getFuzzyMinLength ( ) { return fuzzyMinLength ; } int getFuzzyPrefixLength ( ) { return fuzzyPrefixLength ; } boolean isUnicodeAware ( ) { return unicodeAware ; } int getMaxDeterminizedStates ( ) { return maxDeterminizedStates ; } @Override public XContentBuilder toXContent ( XContentBuilder builder , Params params ) throws IOException { builder . startObject ( <str> ) ; builder . field ( Fuzziness . FIELD . getPreferredName ( ) , editDistance ) ; builder . field ( <str> , transpositions ) ; builder . field ( <str> , fuzzyMinLength ) ; builder . field ( <str> , fuzzyPrefixLength ) ; builder . field ( <str> , unicodeAware ) ; builder . field ( <str> , maxDeterminizedStates ) ; builder . endObject ( ) ; return builder ; } } public static class RegexOptionsBuilder implements ToXContent { private int flagsValue = RegExp . ALL ; private int maxDeterminizedStates = Operations . DEFAULT_MAX_DETERMINIZED_STATES ; public RegexOptionsBuilder ( ) { } public RegexOptionsBuilder setFlags ( String flags ) { this . flagsValue = RegexpFlag . resolveValue ( flags ) ; return this ; } public RegexOptionsBuilder setMaxDeterminizedStates ( int maxDeterminizedStates ) { this . maxDeterminizedStates = maxDeterminizedStates ; return this ; } int getFlagsValue ( ) { return flagsValue ; } int getMaxDeterminizedStates ( ) { return maxDeterminizedStates ; } @Override public XContentBuilder toXContent ( XContentBuilder builder , Params params ) throws IOException { builder . startObject ( <str> ) ; builder . field ( <str> , flagsValue ) ; builder . field ( <str> , maxDeterminizedStates ) ; builder . endObject ( ) ; return builder ; } } public CompletionSuggestionBuilder prefix ( String prefix ) { super . setPrefix ( prefix ) ; return this ; } public CompletionSuggestionBuilder prefix ( String prefix , Fuzziness fuzziness ) { super . setPrefix ( prefix ) ; this . fuzzyOptionsBuilder = new FuzzyOptionsBuilder ( ) . setFuzziness ( fuzziness ) ; return this ; } public CompletionSuggestionBuilder prefix ( String prefix , FuzzyOptionsBuilder fuzzyOptionsBuilder ) { super . setPrefix ( prefix ) ; this . fuzzyOptionsBuilder = fuzzyOptionsBuilder ; return this ; } public CompletionSuggestionBuilder regex ( String regex ) { super . setRegex ( regex ) ; return this ; } public CompletionSuggestionBuilder regex ( String regex , RegexOptionsBuilder regexOptionsBuilder ) { this . regex ( regex ) ; this . regexOptionsBuilder = regexOptionsBuilder ; return this ; } public CompletionSuggestionBuilder payload ( String . . . fields ) { Collections . addAll ( this . payloadFields , fields ) ; return this ; } public CompletionSuggestionBuilder categoryContexts ( String name , CategoryQueryContext . . . queryContexts ) { return contexts ( name , queryContexts ) ; } public CompletionSuggestionBuilder geoContexts ( String name , GeoQueryContext . . . queryContexts ) { return contexts ( name , queryContexts ) ; } private CompletionSuggestionBuilder contexts ( String name , ToXContent . . . queryContexts ) { List < ToXContent > contexts = this . queryContexts . get ( name ) ; if ( contexts = = null ) { contexts = new ArrayList < > ( <int> ) ; this . queryContexts . put ( name , contexts ) ; } Collections . addAll ( contexts , queryContexts ) ; return this ; } @Override protected XContentBuilder innerToXContent ( XContentBuilder builder , Params params ) throws IOException { if ( payloadFields ! = null ) { builder . startArray ( <str> ) ; for ( String field : payloadFields ) { builder . value ( field ) ; } builder . endArray ( ) ; } if ( fuzzyOptionsBuilder ! = null ) { fuzzyOptionsBuilder . toXContent ( builder , params ) ; } if ( regexOptionsBuilder ! = null ) { regexOptionsBuilder . toXContent ( builder , params ) ; } if ( queryContexts . isEmpty ( ) = = false ) { builder . startObject ( <str> ) ; for ( Map . Entry < String , List < ToXContent > > entry : this . queryContexts . entrySet ( ) ) { builder . startArray ( entry . getKey ( ) ) ; for ( ToXContent queryContext : entry . getValue ( ) ) { queryContext . toXContent ( builder , params ) ; } builder . endArray ( ) ; } builder . endObject ( ) ; } return builder ; } } 
