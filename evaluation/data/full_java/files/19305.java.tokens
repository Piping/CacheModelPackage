package io . netty . handler . codec . http . websocketx ; import io . netty . buffer . ByteBuf ; import io . netty . channel . embedded . EmbeddedChannel ; import io . netty . handler . codec . http . DefaultFullHttpRequest ; import io . netty . handler . codec . http . FullHttpRequest ; import io . netty . handler . codec . http . HttpHeaderNames ; import io . netty . handler . codec . http . HttpHeaderValues ; import io . netty . handler . codec . http . HttpMethod ; import io . netty . handler . codec . http . HttpObjectAggregator ; import io . netty . handler . codec . http . HttpRequestDecoder ; import io . netty . handler . codec . http . HttpResponse ; import io . netty . handler . codec . http . HttpResponseDecoder ; import io . netty . handler . codec . http . HttpResponseEncoder ; import io . netty . util . ReferenceCountUtil ; import org . junit . Assert ; import org . junit . Test ; import static io . netty . handler . codec . http . HttpVersion . * ; public class WebSocketServerHandshaker13Test { @Test public void testPerformOpeningHandshake ( ) { testPerformOpeningHandshake0 ( true ) ; } @Test public void testPerformOpeningHandshakeSubProtocolNotSupported ( ) { testPerformOpeningHandshake0 ( false ) ; } private static void testPerformOpeningHandshake0 ( boolean subProtocol ) { EmbeddedChannel ch = new EmbeddedChannel ( new HttpObjectAggregator ( <int> ) , new HttpRequestDecoder ( ) , new HttpResponseEncoder ( ) ) ; FullHttpRequest req = ReferenceCountUtil . releaseLater ( new DefaultFullHttpRequest ( HTTP_1_1 , HttpMethod . GET , <str> ) ) ; req . headers ( ) . set ( HttpHeaderNames . HOST , <str> ) ; req . headers ( ) . set ( HttpHeaderNames . UPGRADE , HttpHeaderValues . WEBSOCKET ) ; req . headers ( ) . set ( HttpHeaderNames . CONNECTION , <str> ) ; req . headers ( ) . set ( HttpHeaderNames . SEC_WEBSOCKET_KEY , <str> ) ; req . headers ( ) . set ( HttpHeaderNames . SEC_WEBSOCKET_ORIGIN , <str> ) ; req . headers ( ) . set ( HttpHeaderNames . SEC_WEBSOCKET_PROTOCOL , <str> ) ; req . headers ( ) . set ( HttpHeaderNames . SEC_WEBSOCKET_VERSION , <str> ) ; if ( subProtocol ) { new WebSocketServerHandshaker13 ( <str> , <str> , false , Integer . MAX_VALUE , false ) . handshake ( ch , req ) ; } else { new WebSocketServerHandshaker13 ( <str> , null , false , Integer . MAX_VALUE , false ) . handshake ( ch , req ) ; } ByteBuf resBuf = ch . readOutbound ( ) ; EmbeddedChannel ch2 = new EmbeddedChannel ( new HttpResponseDecoder ( ) ) ; ch2 . writeInbound ( resBuf ) ; HttpResponse res = ch2 . readInbound ( ) ; Assert . assertEquals ( <str> , res . headers ( ) . get ( HttpHeaderNames . SEC_WEBSOCKET_ACCEPT ) ) ; if ( subProtocol ) { Assert . assertEquals ( <str> , res . headers ( ) . get ( HttpHeaderNames . SEC_WEBSOCKET_PROTOCOL ) ) ; } else { Assert . assertNull ( res . headers ( ) . get ( HttpHeaderNames . SEC_WEBSOCKET_PROTOCOL ) ) ; } ReferenceCountUtil . release ( res ) ; } } 
