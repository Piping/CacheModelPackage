package org . gradle . api . internal . tasks . compile ; import com . google . common . base . Joiner ; import com . google . common . collect . Lists ; import org . gradle . api . file . FileCollection ; import org . gradle . api . internal . file . collections . SimpleFileCollection ; import org . gradle . api . internal . tasks . SimpleWorkResult ; import org . gradle . api . logging . Logger ; import org . gradle . api . logging . Logging ; import org . gradle . api . specs . Spec ; import org . gradle . api . tasks . WorkResult ; import org . gradle . language . base . internal . compile . Compiler ; import org . gradle . util . CollectionUtils ; import java . io . File ; import java . util . List ; public class NormalizingJavaCompiler implements Compiler < JavaCompileSpec > { private static final Logger LOGGER = Logging . getLogger ( NormalizingJavaCompiler . class ) ; private final Compiler < JavaCompileSpec > delegate ; public NormalizingJavaCompiler ( Compiler < JavaCompileSpec > delegate ) { this . delegate = delegate ; } public WorkResult execute ( JavaCompileSpec spec ) { resolveAndFilterSourceFiles ( spec ) ; resolveClasspath ( spec ) ; resolveNonStringsInCompilerArgs ( spec ) ; logSourceFiles ( spec ) ; logCompilerArguments ( spec ) ; return delegateAndHandleErrors ( spec ) ; } private void resolveAndFilterSourceFiles ( JavaCompileSpec spec ) { FileCollection javaOnly = spec . getSource ( ) . filter ( new Spec < File > ( ) { public boolean isSatisfiedBy ( File element ) { return element . getName ( ) . endsWith ( <str> ) ; } } ) ; spec . setSource ( new SimpleFileCollection ( javaOnly . getFiles ( ) ) ) ; } private void resolveClasspath ( JavaCompileSpec spec ) { spec . setClasspath ( new SimpleFileCollection ( Lists . newArrayList ( spec . getClasspath ( ) ) ) ) ; } private void resolveNonStringsInCompilerArgs ( JavaCompileSpec spec ) { spec . getCompileOptions ( ) . setCompilerArgs ( CollectionUtils . toStringList ( spec . getCompileOptions ( ) . getCompilerArgs ( ) ) ) ; } private void logSourceFiles ( JavaCompileSpec spec ) { if ( ! spec . getCompileOptions ( ) . isListFiles ( ) ) { return ; } StringBuilder builder = new StringBuilder ( ) ; builder . append ( <str> ) ; for ( File file : spec . getSource ( ) ) { builder . append ( <str> ) ; builder . append ( file ) ; } LOGGER . quiet ( builder . toString ( ) ) ; } private void logCompilerArguments ( JavaCompileSpec spec ) { if ( ! LOGGER . isDebugEnabled ( ) ) { return ; } List < String > compilerArgs = new JavaCompilerArgumentsBuilder ( spec ) . includeLauncherOptions ( true ) . includeSourceFiles ( true ) . build ( ) ; String joinedArgs = Joiner . on ( <str> ) . join ( compilerArgs ) ; LOGGER . debug ( <str> , joinedArgs ) ; } private WorkResult delegateAndHandleErrors ( JavaCompileSpec spec ) { try { return delegate . execute ( spec ) ; } catch ( CompilationFailedException e ) { if ( spec . getCompileOptions ( ) . isFailOnError ( ) ) { throw e ; } LOGGER . debug ( <str> ) ; return new SimpleWorkResult ( false ) ; } } } 
