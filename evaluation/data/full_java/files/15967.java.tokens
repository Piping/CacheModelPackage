package org . gradle . tooling . internal . consumer . connection ; import org . gradle . api . Transformer ; import org . gradle . tooling . internal . adapter . ProtocolToModelAdapter ; import org . gradle . tooling . internal . consumer . parameters . BuildCancellationTokenAdapter ; import org . gradle . tooling . internal . consumer . parameters . ConsumerOperationParameters ; import org . gradle . tooling . internal . consumer . versioning . ModelMapping ; import org . gradle . tooling . internal . consumer . versioning . VersionDetails ; import org . gradle . tooling . internal . protocol . BuildResult ; import org . gradle . tooling . internal . protocol . InternalCancellableConnection ; import org . gradle . tooling . internal . protocol . InternalUnsupportedModelException ; import org . gradle . tooling . internal . protocol . ModelIdentifier ; import org . gradle . tooling . model . internal . Exceptions ; public class CancellableModelBuilderBackedModelProducer extends HasCompatibilityMapperAction implements ModelProducer { private final ProtocolToModelAdapter adapter ; private final VersionDetails versionDetails ; private final ModelMapping modelMapping ; private final InternalCancellableConnection builder ; private final Transformer < RuntimeException , RuntimeException > exceptionTransformer ; public CancellableModelBuilderBackedModelProducer ( ProtocolToModelAdapter adapter , VersionDetails versionDetails , ModelMapping modelMapping , InternalCancellableConnection builder , Transformer < RuntimeException , RuntimeException > exceptionTransformer ) { super ( versionDetails ) ; this . adapter = adapter ; this . versionDetails = versionDetails ; this . modelMapping = modelMapping ; this . builder = builder ; this . exceptionTransformer = exceptionTransformer ; } public < T > T produceModel ( Class < T > type , ConsumerOperationParameters operationParameters ) { if ( ! versionDetails . maySupportModel ( type ) ) { throw Exceptions . unsupportedModel ( type , versionDetails . getVersion ( ) ) ; } final ModelIdentifier modelIdentifier = modelMapping . getModelIdentifierFromModelType ( type ) ; BuildResult < ? > result ; try { result = builder . getModel ( modelIdentifier , new BuildCancellationTokenAdapter ( operationParameters . getCancellationToken ( ) ) , operationParameters ) ; } catch ( InternalUnsupportedModelException e ) { throw Exceptions . unknownModel ( type , e ) ; } catch ( RuntimeException e ) { throw exceptionTransformer . transform ( e ) ; } return adapter . adapt ( type , result . getModel ( ) , getCompatibilityMapperAction ( ) ) ; } } 
