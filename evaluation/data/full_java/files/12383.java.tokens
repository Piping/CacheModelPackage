package org . gradle . api . internal . file . archive ; import org . gradle . api . GradleException ; import org . gradle . api . InvalidUserDataException ; import org . gradle . api . internal . file . FileResource ; import org . gradle . api . internal . file . MaybeCompressedFileResource ; import org . gradle . api . resources . MissingResourceException ; import org . gradle . test . fixtures . file . TestFile ; import org . gradle . test . fixtures . file . TestNameTestDirectoryProvider ; import org . gradle . util . Resources ; import org . junit . Rule ; import org . junit . Test ; import java . util . HashMap ; import java . util . Map ; import static org . gradle . api . file . FileVisitorUtil . * ; import static org . gradle . api . internal . file . TestFiles . fileSystem ; import static org . gradle . api . tasks . AntBuilderAwareUtil . assertSetContainsForAllTypes ; import static org . gradle . util . WrapUtil . toList ; import static org . hamcrest . Matchers . * ; import static org . junit . Assert . assertThat ; import static org . junit . Assert . fail ; public class TarFileTreeTest { @Rule public final TestNameTestDirectoryProvider tmpDir = new TestNameTestDirectoryProvider ( ) ; @Rule public final Resources resources = new Resources ( ) ; private final TestFile tarFile = tmpDir . getTestDirectory ( ) . file ( <str> ) ; private final TestFile rootDir = tmpDir . getTestDirectory ( ) . file ( <str> ) ; private final TestFile expandDir = tmpDir . getTestDirectory ( ) . file ( <str> ) ; private final TarFileTree tree = new TarFileTree ( tarFile , new MaybeCompressedFileResource ( new FileResource ( tarFile ) ) , expandDir , fileSystem ( ) ) ; @Test public void displayName ( ) { assertThat ( tree . getDisplayName ( ) , equalTo ( <str> + tarFile + <str> ) ) ; } @Test public void visitsContentsOfTarFile ( ) { rootDir . file ( <str> ) . write ( <str> ) ; rootDir . file ( <str> ) . write ( <str> ) ; rootDir . tarTo ( tarFile ) ; assertVisits ( tree , toList ( <str> , <str> ) , toList ( <str> , <str> ) ) ; assertSetContainsForAllTypes ( tree , toList ( <str> , <str> ) ) ; } @Test public void readsGzippedTarFile ( ) { TestFile tgz = tmpDir . getTestDirectory ( ) . file ( <str> ) ; rootDir . file ( <str> ) . write ( <str> ) ; rootDir . file ( <str> ) . write ( <str> ) ; rootDir . tgzTo ( tgz ) ; TarFileTree tree = new TarFileTree ( tarFile , new MaybeCompressedFileResource ( new FileResource ( tgz ) ) , expandDir , fileSystem ( ) ) ; assertVisits ( tree , toList ( <str> , <str> ) , toList ( <str> , <str> ) ) ; assertSetContainsForAllTypes ( tree , toList ( <str> , <str> ) ) ; } @Test public void readsBzippedTarFile ( ) { TestFile tbz2 = tmpDir . getTestDirectory ( ) . file ( <str> ) ; rootDir . file ( <str> ) . write ( <str> ) ; rootDir . file ( <str> ) . write ( <str> ) ; rootDir . tbzTo ( tbz2 ) ; TarFileTree tree = new TarFileTree ( tarFile , new MaybeCompressedFileResource ( new FileResource ( tbz2 ) ) , expandDir , fileSystem ( ) ) ; assertVisits ( tree , toList ( <str> , <str> ) , toList ( <str> , <str> ) ) ; assertSetContainsForAllTypes ( tree , toList ( <str> , <str> ) ) ; } @Test public void canStopVisitingFiles ( ) { rootDir . file ( <str> ) . write ( <str> ) ; rootDir . file ( <str> ) . write ( <str> ) ; rootDir . tarTo ( tarFile ) ; assertCanStopVisiting ( tree ) ; } @Test public void failsWhenTarFileDoesNotExist ( ) { try { tree . visit ( null ) ; fail ( ) ; } catch ( InvalidUserDataException e ) { assertThat ( e . getMessage ( ) , containsString ( <str> + tarFile + <str> ) ) ; assertThat ( e . getCause ( ) , instanceOf ( MissingResourceException . class ) ) ; } } @Test public void failsWhenTarFileIsADirectory ( ) { tarFile . createDir ( ) ; try { tree . visit ( null ) ; fail ( ) ; } catch ( InvalidUserDataException e ) { assertThat ( e . getMessage ( ) , containsString ( <str> + tarFile + <str> ) ) ; } } @Test public void wrapsFailureToUntarFile ( ) { expandDir . write ( <str> ) ; tarFile . write ( <str> ) ; try { tree . visit ( null ) ; fail ( ) ; } catch ( GradleException e ) { assertThat ( e . getMessage ( ) , containsString ( <str> + tarFile + <str> ) ) ; } } @Test public void expectedFilePermissionsAreFound ( ) { resources . findResource ( <str> ) . copyTo ( tarFile ) ; final Map < String , Integer > expected = new HashMap < String , Integer > ( ) ; expected . put ( <str> , <oct> ) ; expected . put ( <str> , <oct> ) ; assertVisitsPermissions ( tree , expected ) ; } @Test public void readsTarFileWithNullPermissions ( ) { resources . findResource ( <str> ) . copyTo ( tarFile ) ; final Map < String , Integer > expected = new HashMap < String , Integer > ( ) ; expected . put ( <str> , <oct> ) ; assertVisitsPermissions ( tree , expected ) ; } } 
