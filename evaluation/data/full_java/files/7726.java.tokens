package org . elasticsearch . action . admin . indices . cache . clear ; import org . elasticsearch . test . ESIntegTestCase ; import org . elasticsearch . test . ESIntegTestCase . ClusterScope ; import java . util . Arrays ; import static org . elasticsearch . cluster . metadata . IndexMetaData . SETTING_BLOCKS_METADATA ; import static org . elasticsearch . cluster . metadata . IndexMetaData . SETTING_BLOCKS_READ ; import static org . elasticsearch . cluster . metadata . IndexMetaData . SETTING_BLOCKS_WRITE ; import static org . elasticsearch . cluster . metadata . IndexMetaData . SETTING_READ_ONLY ; import static org . elasticsearch . test . hamcrest . ElasticsearchAssertions . assertBlocked ; import static org . elasticsearch . test . hamcrest . ElasticsearchAssertions . assertNoFailures ; import static org . hamcrest . Matchers . equalTo ; @ClusterScope ( scope = ESIntegTestCase . Scope . TEST ) public class ClearIndicesCacheBlocksIT extends ESIntegTestCase { public void testClearIndicesCacheWithBlocks ( ) { createIndex ( <str> ) ; ensureGreen ( <str> ) ; NumShards numShards = getNumShards ( <str> ) ; for ( String blockSetting : Arrays . asList ( SETTING_BLOCKS_READ , SETTING_BLOCKS_WRITE ) ) { try { enableIndexBlock ( <str> , blockSetting ) ; ClearIndicesCacheResponse clearIndicesCacheResponse = client ( ) . admin ( ) . indices ( ) . prepareClearCache ( <str> ) . setFieldDataCache ( true ) . setQueryCache ( true ) . setFieldDataCache ( true ) . execute ( ) . actionGet ( ) ; assertNoFailures ( clearIndicesCacheResponse ) ; assertThat ( clearIndicesCacheResponse . getSuccessfulShards ( ) , equalTo ( numShards . totalNumShards ) ) ; } finally { disableIndexBlock ( <str> , blockSetting ) ; } } for ( String blockSetting : Arrays . asList ( SETTING_READ_ONLY , SETTING_BLOCKS_METADATA ) ) { try { enableIndexBlock ( <str> , blockSetting ) ; assertBlocked ( client ( ) . admin ( ) . indices ( ) . prepareClearCache ( <str> ) . setFieldDataCache ( true ) . setQueryCache ( true ) . setFieldDataCache ( true ) ) ; } finally { disableIndexBlock ( <str> , blockSetting ) ; } } } } 
