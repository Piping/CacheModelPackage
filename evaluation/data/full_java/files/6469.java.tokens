package org . elasticsearch . index . fielddata . fieldcomparator ; import org . apache . lucene . index . LeafReaderContext ; import org . apache . lucene . index . NumericDocValues ; import org . apache . lucene . search . DocIdSetIterator ; import org . apache . lucene . search . FieldComparator ; import org . apache . lucene . search . Scorer ; import org . apache . lucene . search . SortField ; import org . apache . lucene . util . BitSet ; import org . elasticsearch . common . Nullable ; import org . elasticsearch . index . fielddata . IndexFieldData ; import org . elasticsearch . index . fielddata . IndexNumericFieldData ; import org . elasticsearch . index . fielddata . NumericDoubleValues ; import org . elasticsearch . index . fielddata . SortedNumericDoubleValues ; import org . elasticsearch . search . MultiValueMode ; import java . io . IOException ; public class DoubleValuesComparatorSource extends IndexFieldData . XFieldComparatorSource { private final IndexNumericFieldData indexFieldData ; private final Object missingValue ; private final MultiValueMode sortMode ; private final Nested nested ; public DoubleValuesComparatorSource ( IndexNumericFieldData indexFieldData , @Nullable Object missingValue , MultiValueMode sortMode , Nested nested ) { this . indexFieldData = indexFieldData ; this . missingValue = missingValue ; this . sortMode = sortMode ; this . nested = nested ; } @Override public SortField . Type reducedType ( ) { return SortField . Type . DOUBLE ; } protected SortedNumericDoubleValues getValues ( LeafReaderContext context ) throws IOException { return indexFieldData . load ( context ) . getDoubleValues ( ) ; } protected void setScorer ( Scorer scorer ) { } @Override public FieldComparator < ? > newComparator ( String fieldname , int numHits , int sortPos , boolean reversed ) throws IOException { assert indexFieldData = = null | | fieldname . equals ( indexFieldData . getFieldNames ( ) . indexName ( ) ) ; final double dMissingValue = ( Double ) missingObject ( missingValue , reversed ) ; return new FieldComparator . DoubleComparator ( numHits , null , null ) { @Override protected NumericDocValues getNumericDocValues ( LeafReaderContext context , String field ) throws IOException { final SortedNumericDoubleValues values = getValues ( context ) ; final NumericDoubleValues selectedValues ; if ( nested = = null ) { selectedValues = sortMode . select ( values , dMissingValue ) ; } else { final BitSet rootDocs = nested . rootDocs ( context ) ; final DocIdSetIterator innerDocs = nested . innerDocs ( context ) ; selectedValues = sortMode . select ( values , dMissingValue , rootDocs , innerDocs , context . reader ( ) . maxDoc ( ) ) ; } return selectedValues . getRawDoubleValues ( ) ; } @Override public void setScorer ( Scorer scorer ) { DoubleValuesComparatorSource . this . setScorer ( scorer ) ; } } ; } } 
