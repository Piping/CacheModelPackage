package org . elasticsearch . action . admin . indices . segments ; import org . elasticsearch . test . ESIntegTestCase ; import org . elasticsearch . test . ESIntegTestCase . ClusterScope ; import java . util . Arrays ; import static org . elasticsearch . cluster . metadata . IndexMetaData . SETTING_BLOCKS_METADATA ; import static org . elasticsearch . cluster . metadata . IndexMetaData . SETTING_BLOCKS_READ ; import static org . elasticsearch . cluster . metadata . IndexMetaData . SETTING_BLOCKS_WRITE ; import static org . elasticsearch . cluster . metadata . IndexMetaData . SETTING_READ_ONLY ; import static org . elasticsearch . test . hamcrest . ElasticsearchAssertions . assertBlocked ; import static org . elasticsearch . test . hamcrest . ElasticsearchAssertions . assertNoFailures ; @ClusterScope ( scope = ESIntegTestCase . Scope . TEST ) public class IndicesSegmentsBlocksIT extends ESIntegTestCase { public void testIndicesSegmentsWithBlocks ( ) { createIndex ( <str> ) ; ensureGreen ( <str> ) ; int docs = between ( <int> , <int> ) ; for ( int i = <int> ; i < docs ; i + + ) { client ( ) . prepareIndex ( <str> , <str> , <str> + i ) . setSource ( <str> , <str> ) . execute ( ) . actionGet ( ) ; } client ( ) . admin ( ) . indices ( ) . prepareFlush ( <str> ) . get ( ) ; for ( String blockSetting : Arrays . asList ( SETTING_BLOCKS_READ , SETTING_BLOCKS_WRITE , SETTING_READ_ONLY ) ) { try { enableIndexBlock ( <str> , blockSetting ) ; IndicesSegmentResponse response = client ( ) . admin ( ) . indices ( ) . prepareSegments ( <str> ) . execute ( ) . actionGet ( ) ; assertNoFailures ( response ) ; } finally { disableIndexBlock ( <str> , blockSetting ) ; } } try { enableIndexBlock ( <str> , SETTING_BLOCKS_METADATA ) ; assertBlocked ( client ( ) . admin ( ) . indices ( ) . prepareSegments ( <str> ) ) ; } finally { disableIndexBlock ( <str> , SETTING_BLOCKS_METADATA ) ; } } } 
